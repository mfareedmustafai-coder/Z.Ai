<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Gemini 3 Flash | Powered by Google AI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Merriweather', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            margin-left: auto;
            border-radius: 18px 4px 18px 18px;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .ai-message {
            background: white;
            color: #333;
            margin-right: auto;
            border-radius: 4px 18px 18px 18px;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4f46e5;
        }
        .typing-indicator {
            display: inline-block;
            width: 60px;
            height: 24px;
        }
        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            margin-right: 4px;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .message-content {
            line-height: 1.5;
        }
        .message-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .message-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #dc2626;
        }
        .message-timestamp {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
            display: block;
            text-align: right;
        }
        .model-badge {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 4px;
        }
        .chat-container {
            height: 500px;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glow {
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.2);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .creator-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .creator-footer a {
            color: #4f46e5;
            text-decoration: none;
            font-weight: bold;
        }
        .creator-footer a:hover {
            text-decoration: underline;
        }
        .connection-status {
            transition: all 0.3s ease;
        }
        .connection-success {
            color: #10b981;
            animation: pulse 2s infinite;
        }
        .connection-failed {
            color: #ef4444;
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">
    <!-- Creator Footer -->
    <div class="creator-footer">
        CREATED BY M.FAREED MUSTAFAI
    </div>

    <div class="max-w-4xl mx-auto mb-16">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Gemini 3 Flash AI Chat Assistant</h1>
            <p class="text-white/80">Powered by Google AI | Auto-Connected</p>
        </div>

        <!-- Main Chat Container -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Status Bar -->
            <div class="bg-gradient-to-r from-[#4f46e5] to-[#7c3aed] text-white p-4 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h2 class="font-bold">Gemini 3 Flash Preview</h2>
                        <p class="text-sm opacity-90">
                            Status: 
                            <span id="connection-status-text" class="ml-1">
                                <span class="loading-spinner mr-1"></span> Connecting...
                            </span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="connection-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                    <span class="text-sm" id="connection-text">Connecting</span>
                </div>
            </div>

            <!-- Auto Connection Message -->
            <div id="auto-connect-message" class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 border-b border-green-100">
                <div class="flex items-center">
                    <div class="loading-spinner mr-3"></div>
                    <div>
                        <p class="font-medium text-green-800">Establishing API Connection...</p>
                        <p class="text-sm text-green-600 mt-1">Please wait while we connect to Google AI servers</p>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-box" class="chat-container overflow-y-auto p-6" style="display: none;">
                <!-- Welcome Message will be added after connection -->
            </div>

            <!-- Input Area (Initially Disabled) -->
            <div class="p-6 border-t border-gray-200">
                <div class="relative">
                    <textarea id="user-input" 
                        class="w-full border-2 border-gray-200 rounded-xl p-4 pr-12 focus:outline-none focus:ring-2 focus:ring-[#4f46e5] focus:border-transparent transition resize-none disabled:opacity-50 disabled:cursor-not-allowed"
                        placeholder="Waiting for API connection... (Connecting automatically)"
                        rows="2"
                        onkeydown="handleKeyDown(event)"
                        disabled></textarea>
                    
                    <div class="absolute right-4 bottom-4 flex items-center space-x-2">
                        <button onclick="clearChat()" 
                                class="text-gray-400 hover:text-gray-600 transition p-2 disabled:opacity-50"
                                title="Clear Chat"
                                id="clear-button"
                                disabled>
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button onclick="sendMessage()" 
                                class="bg-gradient-to-r from-[#4f46e5] to-[#7c3aed] text-white rounded-xl p-3 hover:opacity-90 transition duration-300 glow disabled:opacity-50 disabled:cursor-not-allowed"
                                id="send-button"
                                title="Send Message"
                                disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-4">
                    <p class="text-sm text-gray-500 mb-2">Quick prompts (will enable after connection):</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickAction('Who created you?')" 
                                class="text-xs bg-red-100 text-red-700 px-3 py-2 rounded-lg hover:bg-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                id="quick-who"
                                disabled>
                            üë®‚Äçüíª Who made you?
                        </button>
                        <button onclick="quickAction('Explain quantum computing in simple terms')" 
                                class="text-xs bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                id="quick-quantum"
                                disabled>
                            ü§î Explain Quantum Computing
                        </button>
                        <button onclick="quickAction('Write a Python function to calculate factorial')" 
                                class="text-xs bg-green-100 text-green-700 px-3 py-2 rounded-lg hover:bg-green-200 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                id="quick-python"
                                disabled>
                            üíª Python Code Example
                        </button>
                        <button onclick="quickAction('Tell me a funny joke about AI')" 
                                class="text-xs bg-purple-100 text-purple-700 px-3 py-2 rounded-lg hover:bg-purple-200 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                id="quick-joke"
                                disabled>
                            üòÑ Tell a Joke
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-white/70 text-sm">
            <p>Powered by <a href="https://ai.google.dev/" target="_blank" class="underline hover:text-white">Google AI</a> | 
            Model: <span class="font-mono">gemini-3-flash-preview</span> | 
            API Status: <span id="api-status" class="connection-status">
                <span class="loading-spinner mr-1"></span> Auto-connecting...
            </span></p>
        </div>
    </div>

    <script>
        // Configuration - GOOGLE GEMINI 3 FLASH
        const GOOGLE_API_KEY = "AIzaSyDUhF3rn_Fn_ZlhtkjCfe-nPKWt0FSl4Gs"; // Your Google AI API Key
        const MODEL_ID = "gemini-3-flash-preview";
        const CREATOR_NAME = "Muhammad Fareed Mustafai";
        
        // DOM Elements
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const clearButton = document.getElementById('clear-button');
        const apiStatus = document.getElementById('api-status');
        const connectionIndicator = document.getElementById('connection-indicator');
        const connectionText = document.getElementById('connection-text');
        const connectionStatusText = document.getElementById('connection-status-text');
        const autoConnectMessage = document.getElementById('auto-connect-message');
        
        // Quick action buttons
        const quickWho = document.getElementById('quick-who');
        const quickQuantum = document.getElementById('quick-quantum');
        const quickPython = document.getElementById('quick-python');
        const quickJoke = document.getElementById('quick-joke');
        
        // Conversation History
        let conversationHistory = [];
        let isConnected = false;
        
        // Initialize - Auto Connect on Load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Gemini 3 Flash Chat initializing...');
            console.log('CREATED BY ' + CREATOR_NAME);
            
            // Show loading state
            updateConnectionStatus('connecting', 'Auto-connecting to Google AI...');
            
            // Auto-resize textarea
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Start auto-connection process
            await autoConnect();
        });
        
        // Auto-connect function
        async function autoConnect() {
            try {
                console.log('Starting automatic API connection to Google AI...');
                
                // Step 1: Test API connection with a simple request
                updateConnectionStatus('connecting', 'Authenticating with Google AI...');
                
                // Test connection with a simple request
                const testResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Hello"
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 10
                        }
                    })
                });
                
                if (!testResponse.ok) {
                    const errorData = await testResponse.json();
                    throw new Error(errorData.error?.message || `HTTP ${testResponse.status}`);
                }
                
                // Step 2: Success - enable chat
                updateConnectionStatus('connected', 'Connected to Gemini 3 Flash');
                
                // Hide auto-connect message
                autoConnectMessage.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center mr-3">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div>
                            <p class="font-medium text-green-800">‚úÖ Google AI Connection Established!</p>
                            <p class="text-sm text-green-600 mt-1">Gemini 3 Flash is ready to chat</p>
                        </div>
                    </div>
                `;
                
                // Show chat box after a delay
                setTimeout(() => {
                    autoConnectMessage.style.display = 'none';
                    chatBox.style.display = 'block';
                    
                    // Add welcome message
                    showWelcomeMessage();
                    
                    // Enable all controls
                    enableAllControls();
                    
                    console.log('‚úÖ Google AI connection successful! Chat ready.');
                }, 1000);
                
            } catch (error) {
                console.error('Auto-connection failed:', error);
                updateConnectionStatus('failed', `Connection failed: ${error.message}`);
                
                // Show error message
                autoConnectMessage.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full bg-red-500 flex items-center justify-center mr-3">
                            <i class="fas fa-times text-white text-xs"></i>
                        </div>
                        <div>
                            <p class="font-medium text-red-800">‚ùå Google AI Connection Failed</p>
                            <p class="text-sm text-red-600 mt-1">${error.message || 'Unable to connect to Google AI API'}</p>
                            <button onclick="retryConnection()" class="mt-2 text-sm bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 transition">
                                <i class="fas fa-redo mr-1"></i> Retry Connection
                            </button>
                        </div>
                    </div>
                `;
                
                // Still show chat box but with error state
                setTimeout(() => {
                    chatBox.style.display = 'block';
                    showErrorMessage();
                }, 1000);
            }
        }
        
        // Update connection status UI
        function updateConnectionStatus(status, message) {
            switch(status) {
                case 'connecting':
                    connectionIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 animate-pulse';
                    connectionText.textContent = 'Connecting';
                    connectionStatusText.innerHTML = `<span class="loading-spinner mr-1"></span> ${message}`;
                    apiStatus.innerHTML = `<span class="loading-spinner mr-1"></span> ${message}`;
                    apiStatus.className = 'connection-status';
                    break;
                    
                case 'connected':
                    isConnected = true;
                    connectionIndicator.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
                    connectionText.textContent = 'Connected';
                    connectionStatusText.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${message}`;
                    connectionStatusText.className = 'connection-success';
                    apiStatus.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${message}`;
                    apiStatus.className = 'connection-status connection-success';
                    break;
                    
                case 'failed':
                    isConnected = false;
                    connectionIndicator.className = 'w-3 h-3 rounded-full bg-red-400';
                    connectionText.textContent = 'Failed';
                    connectionStatusText.innerHTML = `<i class="fas fa-times-circle mr-1"></i> ${message}`;
                    connectionStatusText.className = 'connection-failed';
                    apiStatus.innerHTML = `<i class="fas fa-times-circle mr-1"></i> ${message}`;
                    apiStatus.className = 'connection-status connection-failed';
                    break;
            }
        }
        
        // Retry connection
        async function retryConnection() {
            updateConnectionStatus('connecting', 'Retrying connection...');
            
            // Reset auto-connect message
            autoConnectMessage.innerHTML = `
                <div class="flex items-center">
                    <div class="loading-spinner mr-3"></div>
                    <div>
                        <p class="font-medium text-green-800">Retrying Google AI Connection...</p>
                        <p class="text-sm text-green-600 mt-1">Please wait while we reconnect</p>
                    </div>
                </div>
            `;
            autoConnectMessage.style.display = 'block';
            
            // Try to reconnect
            await autoConnect();
        }
        
        // Enable all controls after successful connection
        function enableAllControls() {
            userInput.disabled = false;
            userInput.placeholder = "Type your message here... (Shift+Enter for new line)";
            
            sendButton.disabled = false;
            clearButton.disabled = false;
            
            // Enable quick action buttons
            quickWho.disabled = false;
            quickQuantum.disabled = false;
            quickPython.disabled = false;
            quickJoke.disabled = false;
            
            // Focus on input
            setTimeout(() => {
                userInput.focus();
            }, 500);
        }
        
        // Show welcome message
        function showWelcomeMessage() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'ai-message p-4 mb-6 fade-in';
            welcomeDiv.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="model-badge pulse">
                        <i class="fab fa-google mr-1"></i> Gemini 3 Flash
                    </div>
                    <span class="text-xs text-gray-500 ml-2">via Google AI</span>
                </div>
                <div class="message-content">
                    <h3 class="font-bold text-lg mb-2">‚úÖ Google AI Connection Successful! Hello! üëã</h3>
                    <p class="mb-3">I'm powered by <strong>Gemini 3 Flash Preview</strong> from Google AI. Your connection has been automatically established!</p>
                    
                    <div class="bg-green-50 p-3 rounded-lg mb-3 border border-green-100">
                        <p class="text-sm font-medium text-green-800 mb-1"><i class="fas fa-check-circle mr-2"></i>Google AI Status: Connected</p>
                        <p class="text-xs text-green-600">Model: gemini-3-flash-preview | Auto-connected</p>
                    </div>
                    
                    <p class="mb-2"><strong>Pro Tip:</strong> Try asking "Who created you?" to learn about my developer!</p>
                    
                    <p class="text-sm text-gray-600">You can ask me about:</p>
                    <ul class="text-sm text-gray-600 ml-5 mt-1 space-y-1">
                        <li>‚Ä¢ Programming & technology questions</li>
                        <li>‚Ä¢ Creative writing and brainstorming</li>
                        <li>‚Ä¢ Problem solving and analysis</li>
                        <li>‚Ä¢ General knowledge and explanations</li>
                    </ul>
                </div>
                <span class="message-timestamp">Auto-connected & Ready</span>
            `;
            chatBox.appendChild(welcomeDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // Show error message
        function showErrorMessage() {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'ai-message p-4 mb-6 fade-in';
            errorDiv.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="model-badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <i class="fas fa-exclamation-triangle mr-1"></i> Connection Error
                    </div>
                </div>
                <div class="message-content">
                    <h3 class="font-bold text-lg mb-2 text-red-600">‚ùå Google AI Connection Failed</h3>
                    <p class="mb-3">Unable to connect to Google AI API. Please check:</p>
                    
                    <div class="bg-red-50 p-3 rounded-lg mb-3 border border-red-100">
                        <ul class="text-sm text-red-700 space-y-1">
                            <li><i class="fas fa-check-circle mr-2"></i>Your internet connection</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Google AI API key validity</li>
                            <li><i class="fas fa-check-circle mr-2"></i>API quota availability</li>
                        </ul>
                    </div>
                    
                    <p class="mb-2">You can still ask questions, but they will be processed locally with basic responses.</p>
                    
                    <button onclick="retryConnection()" class="mt-3 text-sm bg-gradient-to-r from-[#4f46e5] to-[#7c3aed] text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                        <i class="fas fa-redo mr-2"></i> Retry Connection
                    </button>
                </div>
                <span class="message-timestamp">Connection Error</span>
            `;
            chatBox.appendChild(errorDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // Handle key events
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Quick actions
        function quickAction(prompt) {
            if (!isConnected) {
                appendMessage("Please wait for the API connection to complete.", 'ai', true);
                return;
            }
            userInput.value = prompt;
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
            userInput.focus();
        }
        
        // Check if message asks about creator
        function isAskingAboutCreator(message) {
            const lowerMessage = message.toLowerCase().trim();
            const creatorKeywords = [
                'who made you',
                'who created you',
                'who built you',
                'who developed you',
                'who designed you',
                'who programmed you',
                'who coded you',
                'who is your creator',
                'who is your developer',
                'who is your programmer',
                'who is your maker',
                'who is your father',
                'who is your parent',
                'made by who',
                'created by who',
                'built by who',
                'fareed',
                'mustafai'
            ];
            
            return creatorKeywords.some(keyword => lowerMessage.includes(keyword));
        }
        
        // Get creator response
        function getCreatorResponse() {
            const responses = [
                `I was created by ${CREATOR_NAME}. He's the talented developer who built this chat interface!`,
                `My creator is ${CREATOR_NAME}. He integrated me with the Gemini 3 Flash AI model from Google AI.`,
                `${CREATOR_NAME} is my creator. He developed this amazing chat application where we can talk!`,
                `This chat interface was built by ${CREATOR_NAME}. He's the one who made it possible for us to communicate!`,
                `I'm powered by Google's Gemini 3 Flash AI, but this chat application was created by ${CREATOR_NAME}.`
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Send message function
        async function sendMessage() {
            if (!isConnected) {
                appendMessage("Please wait for the API connection to complete. The system is trying to reconnect automatically.", 'ai', true);
                retryConnection();
                return;
            }
            
            const message = userInput.value.trim();
            if (!message) return;
            
            // Disable input and button
            userInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Add user message to chat
            appendMessage(message, 'user');
            
            // Clear input
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Add to conversation history
            conversationHistory.push({
                role: "user",
                content: message
            });
            
            // Check if asking about creator
            if (isAskingAboutCreator(message)) {
                // Remove typing indicator if any
                setTimeout(() => {
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    userInput.disabled = false;
                    userInput.focus();
                }, 100);
                
                // Show typing indicator
                const typingId = showTypingIndicator();
                
                // Simulate thinking delay
                setTimeout(() => {
                    removeTypingIndicator(typingId);
                    const creatorResponse = getCreatorResponse();
                    appendMessage(creatorResponse, 'ai');
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: "assistant",
                        content: creatorResponse
                    });
                }, 1500);
                
                return;
            }
            
            // Show typing indicator for regular messages
            const typingId = showTypingIndicator();
            
            try {
                // Get response from Google Gemini
                const response = await getGeminiResponse();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                // Add AI response to chat
                appendMessage(response, 'ai');
                
                // Add to conversation history
                conversationHistory.push({
                    role: "assistant",
                    content: response
                });
                
                // Limit history to last 15 messages
                if (conversationHistory.length > 15) {
                    conversationHistory = conversationHistory.slice(-15);
                }
                
            } catch (error) {
                removeTypingIndicator(typingId);
                console.error('Error:', error);
                
                let errorMessage = "Sorry, I encountered an error. ";
                
                if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage += "API key authentication failed. The system will try to reconnect.";
                    isConnected = false;
                    updateConnectionStatus('failed', 'API Key Error');
                    setTimeout(retryConnection, 3000);
                } else if (error.message.includes('429')) {
                    errorMessage += "Rate limit exceeded. Please try again in a moment.";
                } else if (error.message.includes('model')) {
                    errorMessage += "The model is currently unavailable. Please try another model.";
                } else if (error.message.includes('network')) {
                    errorMessage += "Network error. Trying to reconnect...";
                    isConnected = false;
                    updateConnectionStatus('failed', 'Network Error');
                    setTimeout(retryConnection, 3000);
                } else {
                    errorMessage += "Error: " + error.message;
                }
                
                appendMessage(errorMessage, 'ai', true);
            } finally {
                // Re-enable input and button
                if (isConnected) {
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    userInput.focus();
                }
            }
        }
        
        // Get Gemini response from Google AI
        async function getGeminiResponse() {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${GOOGLE_API_KEY}`;
            
            // Format conversation for Gemini API
            const contents = conversationHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.content }]
            }));
            
            const payload = {
                contents: contents,
                generationConfig: {
                    temperature: 0.7,
                    topP: 0.9,
                    topK: 40,
                    maxOutputTokens: 1500,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Invalid response format from Google AI');
            }
        }
        
        // Append message to chat
        function appendMessage(content, sender, isError = false) {
            const messageElement = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            if (sender === 'user') {
                messageElement.className = 'user-message p-4 mb-4 fade-in';
                messageElement.innerHTML = `
                    <div class="message-content">${escapeHtml(content)}</div>
                    <span class="message-timestamp">${timestamp}</span>
                `;
            } else {
                messageElement.className = 'ai-message p-4 mb-4 fade-in';
                if (isError) {
                    messageElement.innerHTML = `
                        <div class="message-content text-red-600">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            ${escapeHtml(content)}
                        </div>
                        <span class="message-timestamp">${timestamp} ‚Ä¢ Error</span>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="model-badge">
                                <i class="fab fa-google mr-1"></i> Gemini 3 Flash
                            </div>
                        </div>
                        <div class="message-content">${formatMessage(content)}</div>
                        <span class="message-timestamp">${timestamp}</span>
                    `;
                }
            }
            
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // Format message with basic markdown
        function formatMessage(text) {
            return escapeHtml(text)
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(<p>)?(.*?)(<\/p>)?$/g, '<p>$2</p>')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 hover:underline">$1</a>');
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.id = 'typing-' + Date.now();
            typingElement.className = 'ai-message p-4 mb-4 fade-in';
            typingElement.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="model-badge">
                        <i class="fab fa-google mr-1"></i> Gemini 3 Flash
                    </div>
                </div>
                <div class="typing-indicator mt-2">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span class="message-timestamp">Thinking...</span>
            `;
            chatBox.appendChild(typingElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            return typingElement.id;
        }
        
        // Remove typing indicator
        function removeTypingIndicator(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }
        
        // Clear chat history
        function clearChat() {
            if (conversationHistory.length > 0) {
                if (confirm('Are you sure you want to clear the chat history?')) {
                    chatBox.innerHTML = '';
                    conversationHistory = [];
                    
                    // Add welcome message back
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'ai-message p-4 mb-6 fade-in';
                    welcomeDiv.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="model-badge pulse">
                                <i class="fab fa-google mr-1"></i> Gemini 3 Flash
                            </div>
                            <span class="text-xs text-gray-500 ml-2">via Google AI</span>
                        </div>
                        <div class="message-content">
                            <h3 class="font-bold text-lg mb-2">üí´ Chat Cleared!</h3>
                            <p>I'm ready for a fresh conversation. What would you like to discuss?</p>
                            <p class="mt-2 text-sm text-gray-600">P.S. I was created by ${CREATOR_NAME} üòä</p>
                        </div>
                        <span class="message-timestamp">New conversation started</span>
                    `;
                    chatBox.appendChild(welcomeDiv);
                }
            }
        }
    </script>
</body>
</html>
